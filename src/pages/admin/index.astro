---
// 관리자 페이지 - 브리핑 큐레이팅
const runtime = (Astro.locals as any).runtime;
const ADMIN_PASS = runtime?.env?.ADMIN_PASS || 'aikorea24admin';

const url = new URL(Astro.request.url);
const inputPass = url.searchParams.get('key');
if (inputPass !== ADMIN_PASS) {
  return new Response('Unauthorized', { status: 401 });
}
---
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI코리아24 관리자 - 브리핑 작성</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
    .container { max-width: 960px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.4rem; margin-bottom: 8px; }
    .date-info { color: #94a3b8; margin-bottom: 20px; font-size: 0.9rem; }

    .intro-section { margin-bottom: 24px; }
    .intro-section label { display: block; font-weight: 600; margin-bottom: 6px; color: #60a5fa; }
    .intro-section textarea {
      width: 100%; height: 70px; padding: 10px; border-radius: 8px;
      background: #1e293b; border: 1px solid #334155; color: #e2e8f0;
      font-size: 0.95rem; resize: vertical;
    }

    .filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filters button {
      padding: 6px 14px; border-radius: 6px; border: 1px solid #334155;
      background: #1e293b; color: #94a3b8; cursor: pointer; font-size: 0.85rem;
    }
    .filters button.active { background: #2563eb; color: white; border-color: #2563eb; }

    .news-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
    .news-item {
      padding: 16px; border-radius: 10px; background: #1e293b; border: 1px solid #334155;
      cursor: pointer; transition: all 0.15s;
    }
    .news-item:hover { border-color: #475569; }
    .news-item.selected { border-color: #2563eb; background: #1e293b; }
    .news-item .top-row { display: flex; align-items: center; gap: 10px; }
    .news-item .checkbox {
      width: 20px; height: 20px; border-radius: 4px; border: 2px solid #475569;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .news-item.selected .checkbox { background: #2563eb; border-color: #2563eb; }
    .news-item.selected .checkbox::after { content: '\2713'; color: white; font-size: 14px; }
    .news-item .title { font-size: 1.05rem; font-weight: 600; flex: 1; line-height: 1.4; }
    .news-item .meta { font-size: 0.8rem; color: #64748b; margin-top: 4px; margin-left: 30px; }
    .news-item .desc { font-size: 0.88rem; color: #94a3b8; margin-top: 6px; margin-left: 30px; line-height: 1.5; }
    .news-item .comment-box {
      margin-top: 10px; margin-left: 30px; display: none;
    }
    .news-item .comment-box label {
      display: block; font-size: 0.8rem; color: #60a5fa; margin-bottom: 4px; font-weight: 500;
    }
    .news-item.selected .comment-box { display: block; }
    .news-item .comment-box textarea {
      width: 100%; padding: 10px; border-radius: 6px; height: 56px;
      background: #0f172a; border: 1px solid #334155; color: #e2e8f0; font-size: 0.9rem;
      resize: vertical; line-height: 1.5;
    }
    .news-item .comment-box textarea::placeholder { color: #475569; }

    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 6px; }
    .tag-kr { background: #166534; color: #86efac; }
    .tag-global { background: #1e40af; color: #93c5fd; }
    .tag-policy { background: #7c2d12; color: #fdba74; }
    .tag-benefit { background: #581c87; color: #d8b4fe; }

    .bottom-bar {
      position: sticky; bottom: 0; background: #0f172a; border-top: 1px solid #334155;
      padding: 16px 0; display: flex; justify-content: space-between; align-items: center;
    }
    .selected-count { color: #60a5fa; font-weight: 600; }
    .btn-publish {
      padding: 10px 28px; border-radius: 8px; border: none;
      background: #2563eb; color: white; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    .btn-publish:hover { background: #1d4ed8; }
    .btn-publish:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
    .btn-preview {
      padding: 10px 20px; border-radius: 8px; border: 1px solid #334155;
      background: transparent; color: #94a3b8; cursor: pointer; margin-right: 10px;
    }

    .status-msg { padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none; }
    .status-msg.success { display: block; background: #166534; color: #86efac; }
    .status-msg.error { display: block; background: #7f1d1d; color: #fca5a5; }
    .loading { text-align: center; padding: 40px; color: #64748b; }
  </style>
</head>
<body>
  <div class="container">
    <h1>AI코리아24 브리핑 작성</h1>
    <div class="date-info" id="dateInfo"></div>

    <div id="statusMsg" class="status-msg"></div>

    <div class="intro-section">
      <label>오늘의 인사이트 (브리핑 서두)</label>
      <textarea id="introText" placeholder="오늘 AI 업계의 핵심 흐름을 한두 문장으로 요약하세요..."></textarea>
    </div>

    <div class="filters">
      <button class="active" data-filter="all">전체</button>
      <button data-filter="kr">국내</button>
      <button data-filter="global">해외</button>
      <button data-filter="policy">정책</button>
      <button data-filter="benefit">혜택</button>
    </div>

    <div id="newsList" class="news-list">
      <div class="loading">뉴스를 불러오는 중...</div>
    </div>

    <div class="bottom-bar">
      <span class="selected-count" id="selectedCount">0건 선택</span>
      <div>
        <button class="btn-preview" id="btnPreview">미리보기</button>
        <button class="btn-publish" id="btnPublish" disabled>브리핑 발행</button>
      </div>
    </div>
  </div>

  <script>
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInfo').textContent = today + ' 브리핑';

    let allNews = [];
    let selectedIds = new Set();
    let comments = {};

    async function loadNews(filter = 'all') {
      const res = await fetch('/api/briefing/news/?filter=' + filter + '&limit=100');
      allNews = await res.json();
      renderNews();
    }

    function getTag(item) {
      if (item.country && item.country !== 'kr') return '<span class="tag tag-global">해외</span>';
      if (item.category === 'policy') return '<span class="tag tag-policy">정책</span>';
      if (item.category === 'benefit') return '<span class="tag tag-benefit">혜택</span>';
      return '<span class="tag tag-kr">국내</span>';
    }

    function renderNews() {
      const container = document.getElementById('newsList');
      if (allNews.length === 0) {
        container.innerHTML = '<div class="loading">수집된 뉴스가 없습니다</div>';
        return;
      }
      container.innerHTML = allNews.map(item => {
        const sel = selectedIds.has(item.id) ? 'selected' : '';
        const cmt = comments[item.id] || '';
        const desc = item.description ? item.description.substring(0, 200) + '...' : '';
        return `
          <div class="news-item ${sel}" data-id="${item.id}" onclick="toggleSelect(${item.id})">
            <div class="top-row">
              <div class="checkbox"></div>
              <div class="title">${item.title} ${getTag(item)}</div>
            </div>
            <div class="meta">${item.source || ''} &middot; ${item.pub_date || ''}</div>
            <div class="desc">${desc}</div>
            <div class="comment-box" onclick="event.stopPropagation()">
              <label>나의 코멘트</label>
              <textarea placeholder="이 뉴스가 한국 독자에게 왜 중요한지 한두 문장으로..." 
                     onchange="updateComment(${item.id}, this.value)"
                     onfocus="event.stopPropagation()">${cmt}</textarea>
            </div>
          </div>`;
      }).join('');
    }

    function toggleSelect(id) {
      if (selectedIds.has(id)) {
        selectedIds.delete(id);
      } else {
        selectedIds.add(id);
      }
      renderNews();
      updateCount();
    }

    function updateComment(id, value) {
      comments[id] = value;
    }

    function updateCount() {
      const count = selectedIds.size;
      document.getElementById('selectedCount').textContent = count + '건 선택';
      document.getElementById('btnPublish').disabled = count === 0;
    }

    document.querySelectorAll('.filters button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadNews(btn.dataset.filter);
      });
    });

    document.getElementById('btnPublish').addEventListener('click', async () => {
      const intro = document.getElementById('introText').value;
      const items = [];
      const newsOrder = allNews.filter(n => selectedIds.has(n.id));
      newsOrder.forEach(n => {
        items.push({ news_id: n.id, comment: comments[n.id] || '' });
      });

      const statusEl = document.getElementById('statusMsg');
      try {
        const res = await fetch('/api/briefing/publish/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: today, intro, items })
        });
        const data = await res.json();
        if (data.ok) {
          statusEl.className = 'status-msg success';
          statusEl.textContent = '브리핑 발행 완료! ' + data.items_count + '건';
        } else {
          statusEl.className = 'status-msg error';
          statusEl.textContent = '발행 실패: ' + (data.error || 'unknown');
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = '네트워크 에러: ' + e.message;
      }
    });

    loadNews();
  </script>
</body>
</html>
