---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const url = new URL(Astro.request.url);
const key = url.searchParams.get('key');
if (key !== 'aikorea24admin') {
  return new Response('Unauthorized', { status: 401 });
}
---
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI코리아24 관리자</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f172a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px}
h1{font-size:1.4rem;margin-bottom:4px}
.date{color:#94a3b8;font-size:.85rem;margin-bottom:12px}
.status{font-size:.85rem;margin-bottom:12px;color:#94a3b8}
.intro-label{color:#3b82f6;font-size:.9rem;font-weight:600;margin-bottom:6px}
textarea.intro{width:100%;height:80px;background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:8px;padding:10px;font-size:.9rem;resize:vertical;margin-bottom:14px}
.fbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.fbtn{background:#1e293b;color:#94a3b8;border:1px solid #334155;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.8rem}
.fbtn.on{background:#3b82f6;color:#fff;border-color:#3b82f6}
.card{background:#1e293b;border:2px solid #334155;border-radius:8px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color .15s}
.card.sel{border-color:#3b82f6}
.card h3{font-size:.95rem;margin-bottom:4px}
.card .meta{font-size:.75rem;color:#64748b;margin-bottom:6px}
.card .desc{font-size:.82rem;color:#94a3b8;line-height:1.4}
.card .ck{display:inline-block;width:20px;height:20px;border:2px solid #475569;border-radius:4px;text-align:center;line-height:18px;margin-right:8px;font-size:14px;vertical-align:middle}
.card.sel .ck{background:#3b82f6;border-color:#3b82f6;color:#fff}
.card .cmt{margin-top:8px;display:none}
.card.sel .cmt{display:block}
.card .cmt textarea{width:100%;height:40px;background:#0f172a;color:#e2e8f0;border:1px solid #334155;border-radius:4px;padding:6px;font-size:.8rem}
.bot{position:fixed;bottom:0;left:0;right:0;background:#1e293b;border-top:1px solid #334155;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;z-index:100}
.bot .cnt{color:#3b82f6;font-weight:600}
.bot .pub{background:#2563eb;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-size:.9rem;font-weight:600}
.bot .pub:disabled{background:#334155;color:#64748b;cursor:not-allowed}
.bot .del{background:#dc2626;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.8rem;display:none}
.msg{margin:0 16px;font-size:.85rem}
.msg.ok{color:#4ade80}
.msg.err{color:#f87171}
#list{padding-bottom:80px}
</style>
</head>
<body>
<h1>AI코리아24 브리핑 작성</h1>
<div class="date" id="dinfo"></div>
<div class="status" id="curStatus">확인 중...</div>
<div class="intro-label">오늘의 인사이트 (브리핑 서두)</div>
<textarea class="intro" id="introText" placeholder="오늘 AI 업계의 핵심 흐름을 한두 문장으로..."></textarea>
<div class="fbar" id="fbar"></div>
<div class="fbar" id="dbar">
  <button class="fbtn" data-d="1">오늘</button>
  <button class="fbtn on" data-d="3">3일</button>
  <button class="fbtn" data-d="7">7일</button>
  <button class="fbtn" data-d="14">14일</button>
</div>
<div id="list"></div>
<div class="bot">
  <span class="cnt" id="cnt">0건 선택</span>
  <button class="del" id="delbtn">삭제</button>
  <span class="msg" id="msg"></span>
  <button class="pub" id="pub" disabled>브리핑 발행</button>
</div>

<script is:inline>
document.addEventListener("DOMContentLoaded", function(){
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('dinfo').textContent = today + ' 브리핑';

  var allNews = [];
  var sel = {};
  var cmts = {};
  var days = 3;

  // === 필터 바 ===
  var ftrs = [
    {k:'all',l:'전체'},{k:'kr',l:'국내'},{k:'global',l:'해외'},
    {k:'policy',l:'정책'},{k:'benefit',l:'혜택'},
    {k:'senior',l:'시니어'},{k:'startup',l:'스타트업'},{k:'grant',l:'지원사업'}
  ];
  var fbar = document.getElementById('fbar');
  if(fbar){
    ftrs.forEach(function(f,i){
      var b = document.createElement('button');
      b.className = 'fbtn' + (i===0?' on':'');
      b.textContent = f.l;
      b.setAttribute('data-f', f.k);
      fbar.appendChild(b);
    });
    fbar.addEventListener('click', function(e){
      var b = e.target.closest('.fbtn');
      if(!b) return;
      fbar.querySelectorAll('.fbtn').forEach(function(x){x.classList.remove('on')});
      b.classList.add('on');
      load(b.getAttribute('data-f'));
    });
  }

  // === 날짜 바 ===
  var dbar = document.getElementById('dbar');
  if(dbar){
    dbar.addEventListener('click', function(e){
      var b = e.target.closest('.fbtn');
      if(!b) return;
      dbar.querySelectorAll('.fbtn').forEach(function(x){x.classList.remove('on')});
      b.classList.add('on');
      days = parseInt(b.getAttribute('data-d'));
      var curFilter = document.querySelector('#fbar .fbtn.on');
      load(curFilter ? curFilter.getAttribute('data-f') : 'all');
    });
  }

  // === 그리기 ===
  function draw(){
    var list = document.getElementById('list');
    if(!list) return;
    var html = '';
    for(var i=0;i<allNews.length;i++){
      var n = allNews[i];
      var s = sel[n.id] ? ' sel' : '';
      var badge = (n.country && n.country !== 'kr') ? '해외' : '국내';
      var cat = n.category ? ' ' + n.category : '';
      html += '<div class="card'+s+'" data-nid="'+n.id+'">';
      html += '<div><span class="ck">'+(sel[n.id]?'✓':'')+'</span><h3 style="display:inline">'+n.title+'</h3> <small>'+badge+cat+'</small></div>';
      html += '<div class="meta">'+(n.source||'')+' · '+(n.pub_date||n.created_at||'').substring(0,10)+'</div>';
      html += '<div class="desc">'+(n.description||'').substring(0,120)+'...</div>';
      html += '<div class="cmt"><input type="text" placeholder="이 뉴스가 왜 중요한지..." data-cid="'+n.id+'" value="'+(cmts[n.id]||'')+'" style="width:100%;background:#0f172a;color:#e2e8f0;border:1px solid #334155;border-radius:4px;padding:6px;font-size:.8rem"/>';
      html += '<div style="font-size:.75rem;color:#64748b;margin-top:2px">나의 코멘트</div></div>';
      html += '</div>';
    }
    list.innerHTML = html;
  }

  function upd(){
    var n = 0;
    for(var k in sel) if(sel[k]) n++;
    var cnt = document.getElementById('cnt');
    var pub = document.getElementById('pub');
    if(cnt) cnt.textContent = n + '건 선택';
    if(pub) pub.disabled = (n === 0);
  }

  // === 카드 클릭 (선택/해제) ===
  var list = document.getElementById('list');
  if(list){
    list.addEventListener('click', function(e){
      var card = e.target.closest('.card');
      if(!card) return;
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      var nid = parseInt(card.getAttribute('data-nid'));
      if(sel[nid]) delete sel[nid];
      else sel[nid] = true;
      draw();
      upd();
    });
    list.addEventListener('input', function(e){
      if(e.target.getAttribute('data-cid')){
        cmts[parseInt(e.target.getAttribute('data-cid'))] = e.target.value;
      }
    });
  }

  // === 뉴스 로드 ===
  function load(filter){
    fetch('/api/briefing/news/?filter='+filter+'&days='+days+'&limit=100')
      .then(function(r){return r.json()})
      .then(function(data){
        allNews = Array.isArray(data) ? data : (data.results || []);
        draw();
        upd();
      })
      .catch(function(e){
        console.log('load error:', e);
      });
  }

  // === 브리핑 상태 확인 ===
  function checkStatus(){
    fetch('/api/briefing/latest/')
      .then(function(r){return r.json()})
      .then(function(d){
        var st = document.getElementById('curStatus');
        var db = document.getElementById('delbtn');
        if(!st) return;
        if(d && d.date === today){
          st.innerHTML = '오늘 브리핑 발행됨: <b>' + (d.items ? d.items.length : 0) + '건</b>';
          st.style.color = '#4ade80';
          if(db) db.style.display = 'inline-block';
        } else {
          st.textContent = '오늘 발행된 브리핑 없음';
          st.style.color = '#94a3b8';
          if(db) db.style.display = 'none';
        }
      })
      .catch(function(e){
        console.log('checkStatus error:', e);
      });
  }
  checkStatus();

  // === 삭제 버튼 ===
  var delbtn = document.getElementById('delbtn');
  if(delbtn){
    delbtn.addEventListener('click', function(){
      if(!confirm('오늘 발행된 브리핑을 삭제하시겠습니까?')) return;
      fetch('/api/briefing/publish/', {
        method:'DELETE',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({date:today})
      })
      .then(function(r){return r.json()})
      .then(function(d){
        var msg = document.getElementById('msg');
        if(msg){
          if(d.ok){
            msg.className='msg ok'; msg.textContent='삭제 완료';
          } else {
            msg.className='msg err'; msg.textContent='삭제 실패: '+(d.error||'');
          }
        }
        checkStatus();
      })
      .catch(function(e){
        var msg = document.getElementById('msg');
        if(msg){msg.className='msg err'; msg.textContent='삭제 에러: '+e;}
      });
    });
  }

  // === 발행 버튼 ===
  var pub = document.getElementById('pub');
  if(pub){
    pub.addEventListener('click', function(){
      var intro = document.getElementById('introText');
      var introVal = intro ? intro.value : '';
      var items = [];
      for(var i=0;i<allNews.length;i++){
        var n = allNews[i];
        if(sel[n.id]) items.push({news_id:n.id, comment:cmts[n.id]||''});
      }
      if(items.length === 0){alert('뉴스를 선택해주세요'); return;}

      pub.disabled = true;
      pub.textContent = '발행 중...';

      var msg = document.getElementById('msg');
      fetch('/api/briefing/publish/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({date:today, intro:introVal, items:items})
      })
      .then(function(r){return r.json()})
      .then(function(d){
        if(d.ok){
          if(msg){msg.className='msg ok'; msg.textContent='발행 완료! '+d.items_count+'건';}
          pub.textContent = '발행 완료!';
          checkStatus();
        } else {
          if(msg){msg.className='msg err'; msg.textContent='실패: '+(d.error||'');}
          pub.disabled = false;
          pub.textContent = '브리핑 발행';
        }
      })
      .catch(function(e){
        if(msg){msg.className='msg err'; msg.textContent='에러: '+e.message;}
        pub.disabled = false;
        pub.textContent = '브리핑 발행';
      });
    });
  }

  // === 초기 로드 ===
  load('all');
});
</script>
</body>
</html>
