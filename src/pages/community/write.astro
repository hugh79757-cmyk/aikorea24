---
const session = Astro.cookies.get('session')?.value;
let user: any = null;
if (session) {
  try {
    user = JSON.parse(atob(session.split('.')[1] || session));
  } catch {}
}

if (!user) {
  return Astro.redirect('/api/auth/login');
}

const categoryMap: Record<string, string> = {
  free: 'ììœ ê²Œì‹œíŒ',
  qna: 'ì§ˆë¬¸ë‹µë³€',
  news: 'AI ë‰´ìŠ¤',
  tip: 'ê¿€íŒê³µìœ ',
  project: 'í”„ë¡œì íŠ¸',
};
---

<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹° - aikorea24.kr</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: 'Pretendard', -apple-system, sans-serif; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); }
    textarea, input, select {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
  </style>
</head>
<body class="min-h-screen">

  <header class="glass sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-xl font-bold text-white">ğŸ¤– aikorea24</a>
      <nav class="flex items-center gap-4 text-sm">
        <a href="/community" class="text-gray-300 hover:text-white">â† ëª©ë¡ìœ¼ë¡œ</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">

    <h1 class="text-2xl font-bold text-white mb-8">ê¸€ì“°ê¸°</h1>

    <div id="error-msg" class="hidden bg-red-500/20 border border-red-500/50 text-red-300 px-4 py-3 rounded-lg mb-6"></div>

    <form id="write-form" class="space-y-6">

      <div class="flex gap-4">
        <div class="flex-shrink-0">
          <label class="block text-sm text-gray-400 mb-2">ì¹´í…Œê³ ë¦¬</label>
          <select id="category" class="rounded-lg px-4 py-3 w-40">
            {Object.entries(categoryMap).map(([key, label]) => (
              <option value={key}>{label}</option>
            ))}
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm text-gray-400 mb-2">ì œëª©</label>
          <input type="text" id="title" maxlength="200" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                 class="rounded-lg px-4 py-3 w-full" required />
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-400 mb-2">ë‚´ìš©</label>
        <textarea id="content" rows="15" maxlength="10000" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                  class="rounded-lg px-4 py-3 w-full resize-y" required></textarea>
        <div class="text-right text-xs text-gray-500 mt-1">
          <span id="char-count">0</span> / 10,000
        </div>
      </div>

      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-400">ì‘ì„±ì: {user.name || user.email}</span>
        <div class="flex gap-3">
          <a href="/community" class="px-6 py-3 rounded-lg glass text-gray-300 hover:text-white transition">ì·¨ì†Œ</a>
          <button type="submit" id="submit-btn"
                  class="px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition">
            ë“±ë¡í•˜ê¸°
          </button>
        </div>
      </div>

    </form>
  </main>

  <script>
    const form = document.getElementById('write-form') as HTMLFormElement;
    const contentEl = document.getElementById('content') as HTMLTextAreaElement;
    const charCount = document.getElementById('char-count') as HTMLSpanElement;
    const errorMsg = document.getElementById('error-msg') as HTMLDivElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    contentEl.addEventListener('input', () => {
      charCount.textContent = String(contentEl.value.length);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.classList.add('hidden');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ë“±ë¡ ì¤‘...';

      const title = (document.getElementById('title') as HTMLInputElement).value.trim();
      const content = contentEl.value.trim();
      const category = (document.getElementById('category') as HTMLSelectElement).value;

      if (!title || !content) {
        errorMsg.textContent = 'ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';
        errorMsg.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ë“±ë¡í•˜ê¸°';
        return;
      }

      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, category })
        });

        const data = await res.json();

        if (res.ok && data.success) {
          window.location.href = '/community/' + data.id;
        } else {
          errorMsg.textContent = data.error || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          errorMsg.classList.remove('hidden');
        }
      } catch (err) {
        errorMsg.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        errorMsg.classList.remove('hidden');
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'ë“±ë¡í•˜ê¸°';
    });
  </script>

</body>
</html>
