---
import { getSessionUser, getUserMembership, PLANS } from '../lib/auth';

const runtime = (Astro.locals as any).runtime;
const db = runtime?.env?.DB;
const user = getSessionUser(Astro.cookies);

let currentLevel = 'free';
if (user && db) {
  try {
    const m = await getUserMembership(db, user.email);
    currentLevel = m.level;
  } catch {}
}

const TOSS_CLIENT_KEY = runtime?.env?.TOSS_CLIENT_KEY || '';
---

<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="icon" href="/favicon.png" />
  <title>ìš”ê¸ˆì œ - aikorea24.kr</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body { background: #0f172a; color: #e2e8f0; font-family: 'Pretendard', -apple-system, sans-serif; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); }
    .plan-card { transition: transform 0.3s, box-shadow 0.3s; }
    .plan-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .popular { border: 2px solid #3b82f6; }
  </style>
</head>
<body class="min-h-screen">

  <header class="glass sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-xl font-bold text-gray-900 dark:text-white">ğŸ¤– aikorea24</a>
      <nav class="flex items-center gap-4 text-sm">
        <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">í™ˆ</a>
        <a href="/community" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">ì»¤ë®¤ë‹ˆí‹°</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-16">

    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">ìš”ê¸ˆì œ</h1>
      <p class="text-gray-500 dark:text-gray-400 text-lg">AI ì½˜í…ì¸ ë¥¼ ë” ê¹Šì´ ìˆê²Œ ë§Œë‚˜ë³´ì„¸ìš”.</p>
      {currentLevel !== 'free' && (
        <p class="mt-3 text-blue-400 text-sm">í˜„ì¬ í”Œëœ: {currentLevel.toUpperCase()}</p>
      )}
    </div>

    <!-- ìš”ê¸ˆì œ í† ê¸€ -->
    <div class="flex justify-center mb-10">
      <div class="glass rounded-full p-1 flex">
        <button id="tab-monthly" class="px-6 py-2 rounded-full text-sm font-medium bg-blue-600 text-white transition">ì›”ê°„</button>
        <button id="tab-yearly" class="px-6 py-2 rounded-full text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-white transition">ì—°ê°„ (33% í• ì¸)</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="plans-grid">

      <!-- Free -->
      <div class="glass plan-card rounded-2xl p-8">
        <h3 class="text-lg font-bold text-gray-500 dark:text-gray-400 mb-2">Free</h3>
        <div class="text-4xl font-bold text-white mb-1">â‚©0</div>
        <p class="text-gray-500 text-sm mb-8">ì˜ì›íˆ ë¬´ë£Œ</p>
        <ul class="space-y-3 text-sm text-gray-300 mb-8">
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> ë¬´ë£Œ ê²Œì‹œê¸€ ì—´ëŒ</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> AI ë‰´ìŠ¤ ë¸Œë¦¬í•‘</li>
          <li class="flex items-center gap-2"><span class="text-gray-600">âœ—</span> <span class="text-gray-500">Basic ì½˜í…ì¸ </span></li>
          <li class="flex items-center gap-2"><span class="text-gray-600">âœ—</span> <span class="text-gray-500">Premium ì½˜í…ì¸ </span></li>
        </ul>
        {currentLevel === 'free' ? (
          <div class="w-full py-3 rounded-lg bg-gray-700 text-gray-500 dark:text-gray-400 text-center font-medium">í˜„ì¬ í”Œëœ</div>
        ) : (
          <div class="w-full py-3 rounded-lg bg-gray-700 text-gray-500 dark:text-gray-400 text-center font-medium">ê¸°ë³¸ í”Œëœ</div>
        )}
      </div>

      <!-- Basic -->
      <div class="glass plan-card rounded-2xl p-8">
        <h3 class="text-lg font-bold text-blue-400 mb-2">Basic</h3>
        <div class="price-display">
          <div class="monthly-price text-4xl font-bold text-white mb-1">â‚©4,900<span class="text-lg text-gray-500 dark:text-gray-400">/ì›”</span></div>
          <div class="yearly-price text-4xl font-bold text-white mb-1 hidden">â‚©39,000<span class="text-lg text-gray-500 dark:text-gray-400">/ë…„</span></div>
        </div>
        <p class="text-gray-500 text-sm mb-8">AI í™œìš© ì‹¤ì „ ì½˜í…ì¸ </p>
        <ul class="space-y-3 text-sm text-gray-300 mb-8">
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Freeì˜ ëª¨ë“  ê¸°ëŠ¥</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Basic ì „ìš© ì½˜í…ì¸ </li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> AI ë„êµ¬ ì‹¬ì¸µ ë¦¬ë·°</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> ì§€ì›ì‚¬ì—… ìƒì„¸ ê°€ì´ë“œ</li>
          <li class="flex items-center gap-2"><span class="text-gray-600">âœ—</span> <span class="text-gray-500">Premium ì½˜í…ì¸ </span></li>
        </ul>
        {currentLevel === 'basic' ? (
          <div class="w-full py-3 rounded-lg bg-blue-600/30 text-blue-300 text-center font-medium">í˜„ì¬ í”Œëœ</div>
        ) : (
          <button class="subscribe-btn w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition"
                  data-plan-monthly="basic_monthly" data-plan-yearly="basic_yearly">
            êµ¬ë…í•˜ê¸°
          </button>
        )}
      </div>

      <!-- Premium -->
      <div class="glass plan-card rounded-2xl p-8 popular relative">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-xs font-bold px-4 py-1 rounded-full">BEST</div>
        <h3 class="text-lg font-bold text-purple-400 mb-2">Premium</h3>
        <div class="price-display">
          <div class="monthly-price text-4xl font-bold text-white mb-1">â‚©9,900<span class="text-lg text-gray-500 dark:text-gray-400">/ì›”</span></div>
          <div class="yearly-price text-4xl font-bold text-white mb-1 hidden">â‚©79,000<span class="text-lg text-gray-500 dark:text-gray-400">/ë…„</span></div>
        </div>
        <p class="text-gray-500 text-sm mb-8">ì „ì²´ ì½˜í…ì¸  ë¬´ì œí•œ</p>
        <ul class="space-y-3 text-sm text-gray-300 mb-8">
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Basicì˜ ëª¨ë“  ê¸°ëŠ¥</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Premium ì „ìš© ì½˜í…ì¸ </li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 1:1 AI í™œìš© ìƒë‹´</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> ì§€ì›ì‚¬ì—… ì‹ ì²­ì„œ í…œí”Œë¦¿</li>
          <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> ì‹ ê·œ ì½˜í…ì¸  ìš°ì„  ê³µê°œ</li>
        </ul>
        {currentLevel === 'premium' ? (
          <div class="w-full py-3 rounded-lg bg-purple-600/30 text-purple-300 text-center font-medium">í˜„ì¬ í”Œëœ</div>
        ) : (
          <button class="subscribe-btn w-full py-3 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-medium transition"
                  data-plan-monthly="premium_monthly" data-plan-yearly="premium_yearly">
            êµ¬ë…í•˜ê¸°
          </button>
        )}
      </div>

    </div>

    <!-- ê±´ë³„ êµ¬ë§¤ ì•ˆë‚´ -->
    <div class="glass rounded-2xl p-8 mt-12 text-center">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-3">êµ¬ë… ì—†ì´ ê°œë³„ êµ¬ë§¤ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤</h3>
      <p class="text-gray-500 dark:text-gray-400">ê´€ì‹¬ ìˆëŠ” ì½˜í…ì¸ ë§Œ ê³¨ë¼ì„œ ê±´ë³„ë¡œ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ì½˜í…ì¸  í˜ì´ì§€ì—ì„œ ê°€ê²©ì„ í™•ì¸í•˜ì„¸ìš”.</p>
    </div>

  </main>

  <script src="https://js.tosspayments.com/v1/payment"></script>

  <script define:vars={{ tossClientKey: TOSS_CLIENT_KEY, isLoggedIn: !!user }}>
    let billingCycle = 'monthly';

    const tabMonthly = document.getElementById('tab-monthly');
    const tabYearly = document.getElementById('tab-yearly');
    const monthlyPrices = document.querySelectorAll('.monthly-price');
    const yearlyPrices = document.querySelectorAll('.yearly-price');

    tabMonthly.addEventListener('click', () => {
      billingCycle = 'monthly';
      tabMonthly.classList.add('bg-blue-600', 'text-white'); tabMonthly.classList.remove('text-gray-500 dark:text-gray-400');
      tabYearly.classList.remove('bg-blue-600', 'text-white'); tabYearly.classList.add('text-gray-500 dark:text-gray-400');
      monthlyPrices.forEach(el => el.classList.remove('hidden'));
      yearlyPrices.forEach(el => el.classList.add('hidden'));
    });

    tabYearly.addEventListener('click', () => {
      billingCycle = 'yearly';
      tabYearly.classList.add('bg-blue-600', 'text-white'); tabYearly.classList.remove('text-gray-500 dark:text-gray-400');
      tabMonthly.classList.remove('bg-blue-600', 'text-white'); tabMonthly.classList.add('text-gray-500 dark:text-gray-400');
      yearlyPrices.forEach(el => el.classList.remove('hidden'));
      monthlyPrices.forEach(el => el.classList.add('hidden'));
    });

    document.querySelectorAll('.subscribe-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isLoggedIn) { window.location.href = '/auth/consent'; return; }
        if (!tossClientKey) { alert('ê²°ì œ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'); return; }

        const planKey = billingCycle === 'monthly'
          ? btn.getAttribute('data-plan-monthly')
          : btn.getAttribute('data-plan-yearly');

        btn.disabled = true; btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

        try {
          const res = await fetch('/api/payments/request', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'subscription', planKey })
          });
          const data = await res.json();
          if (!res.ok) { alert(data.error); btn.disabled = false; btn.textContent = 'êµ¬ë…í•˜ê¸°'; return; }

          const tossPayments = TossPayments(tossClientKey);
          await tossPayments.requestPayment('ì¹´ë“œ', {
            amount: data.amount, orderId: data.orderId, orderName: data.orderName,
            customerEmail: data.customerEmail, customerName: data.customerName,
            successUrl: window.location.origin + '/payments/success',
            failUrl: window.location.origin + '/payments/fail',
          });
        } catch (e) {
          console.error(e);
          btn.disabled = false; btn.textContent = 'êµ¬ë…í•˜ê¸°';
        }
      });
    });
  </script>

</body>
</html>
