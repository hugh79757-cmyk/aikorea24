---
export const prerender = false;

const runtime = (Astro.locals as any).runtime;
const db = runtime?.env?.DB;

let briefings: any[] = [];

if (db) {
  try {
    const { results } = await db.prepare(
      `SELECT b.id, b.date, b.status, b.intro,
              (SELECT COUNT(*) FROM briefing_items WHERE briefing_id = b.id) as item_count
       FROM briefings b
       WHERE b.status = 'published'
       ORDER BY b.date DESC
       LIMIT 30`
    ).all();
    briefings = results || [];
  } catch (e) {
    console.error(e);
  }
}
---
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>브리핑 아카이브 - AI코리아24</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,system-ui,'Noto Sans KR',sans-serif;background:#0a0a0f;color:#e2e8f0}
    .container{max-width:720px;margin:0 auto;padding:20px 16px}
    .back{display:inline-block;color:#60a5fa;text-decoration:none;font-size:14px;margin-bottom:20px}
    h1{font-size:24px;font-weight:700;margin-bottom:8px}
    .subtitle{font-size:14px;color:#94a3b8;margin-bottom:24px}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:16px;text-decoration:none;color:#e2e8f0;transition:border-color 0.2s}
    .item:hover{border-color:#60a5fa}
    .item-date{font-size:18px;font-weight:700;color:#f8fafc}
    .badge{display:inline-block;background:#1e3a5f;color:#60a5fa;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:8px}
    .item-meta{font-size:13px;color:#94a3b8;margin-top:4px}
    .item-intro{font-size:13px;color:#cbd5e1;margin-top:8px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .empty{text-align:center;color:#64748b;padding:60px 0;font-size:15px}
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back">← 메인으로</a>
    <h1>브리핑 아카이브</h1>
    <p class="subtitle">AI코리아24 일일 브리핑 모아보기</p>
    {briefings.length === 0 ? (
      <div class="empty">발행된 브리핑이 없습니다.</div>
    ) : (
      <div class="list">
        {briefings.map((b: any) => {
          const d = new Date(b.date + 'T00:00:00');
          const weekday = ['일','월','화','수','목','금','토'][d.getDay()];
          const display = `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${weekday})`;
          return (
            <a href={`/briefing/${b.date}/`} class="item">
              <span class="item-date">{display}</span>
              <span class="badge">{b.item_count}건</span>
              <div class="item-meta">{b.status === 'published' ? '발행완료' : b.status}</div>
              {b.intro && <div class="item-intro">{b.intro}</div>}
            </a>
          );
        })}
      </div>
    )}
  </div>
</body>
</html>
