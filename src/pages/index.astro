---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import HeroSection from '../components/home/HeroSection.astro';
import PolicyBriefing from '../components/home/PolicyBriefing.astro';
import WelfareSection from '../components/home/WelfareSection.astro';
import LatestNews from '../components/home/LatestNews.astro';
import CourseSection from '../components/home/CourseSection.astro';
import LatestBlog from '../components/home/LatestBlog.astro';
import CtaSection from '../components/home/CtaSection.astro';
import DonationBanner from '../components/home/DonationBanner.astro';

// --- 블로그 데이터 ---
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const recentPosts = allPosts.filter(p => p.data.category !== 'AI 강좌').slice(0, 3);
const coursePosts = allPosts.filter(p => p.data.category === 'AI 강좌').slice(0, 3);

// --- D1 데이터 ---
let latestNews: any[] = [];
let policyNews: any[] = [];
let welfareNews: any[] = [];

try {
  const runtime = (Astro.locals as any).runtime;
  const db = runtime?.env?.DB;
  if (db) {
    latestNews = (await db.prepare(
      `SELECT id, title, link, description, source, category, pub_date FROM news WHERE category IN ('news', 'AI') ORDER BY created_at DESC LIMIT 3`
    ).all()).results || [];

    policyNews = (await db.prepare(
      `SELECT id, title, link, description, source, pub_date FROM news WHERE category = 'policy' ORDER BY created_at DESC LIMIT 3`
    ).all()).results || [];

    welfareNews = (await db.prepare(
      `SELECT id, title, link, description, source, pub_date FROM news WHERE category = 'benefit' ORDER BY created_at DESC LIMIT 3`
    ).all()).results || [];
  }
} catch (e) {
  console.error('D1 fetch error:', e);
}
---
<Layout title="AI코리아24" description="AI 도구 추천, 무료 강좌, 정부 지원사업 정보, AI 뉴스를 한국어로 큐레이션합니다. AI, 누구나 쓸 수 있습니다.">
  <div class="bg-white dark:bg-[#0A0E1A] text-gray-900 dark:text-white min-h-screen relative overflow-hidden transition-colors">

    <!-- 앰비언트 글로우 배경 -->
    <div class="fixed inset-0 pointer-events-none z-0">
      <div class="absolute top-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[150px] animate-pulse-slow"></div>
      <div class="absolute top-[30%] right-[-10%] w-[500px] h-[500px] bg-purple-600/15 rounded-full blur-[150px] animate-pulse-slow2"></div>
      <div class="absolute bottom-[-10%] left-[30%] w-[400px] h-[400px] bg-cyan-500/10 rounded-full blur-[120px] animate-pulse-slow3"></div>
    </div>

    <!-- ★ 섹션 순서: 여기서 줄을 바꾸면 첫화면 순서가 바뀜 -->
    <HeroSection />
    <PolicyBriefing items={policyNews} />
    <WelfareSection items={welfareNews} />
    <LatestNews items={latestNews} />
    <CourseSection posts={coursePosts} />
    <LatestBlog posts={recentPosts} />
    <CtaSection />
    <DonationBanner />

  </div>

  <script is:inline src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof particlesJS !== 'undefined' && document.getElementById('particles-js')) {
        particlesJS('particles-js', {
          particles: {
            number: { value: 50, density: { enable: true, value_area: 800 } },
            color: { value: ['#3B82F6', '#8B5CF6', '#06B6D4', '#60A5FA'] },
            shape: { type: 'circle' },
            opacity: { value: 0.5, random: true, anim: { enable: true, speed: 0.5, opacity_min: 0.1, sync: false } },
            size: { value: 2.5, random: true, anim: { enable: true, speed: 1, size_min: 0.5, sync: false } },
            line_linked: { enable: true, distance: 120, color: '#6366F1', opacity: 0.2, width: 1 },
            move: { enable: true, speed: 0.8, direction: 'none', random: true, straight: false, out_mode: 'out' }
          },
          interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'grab' }, onclick: { enable: true, mode: 'push' }, resize: true },
            modes: { grab: { distance: 120, line_linked: { opacity: 0.5 } }, push: { particles_nb: 2 } }
          },
          retina_detect: true
        });
      }
    });
  </script>

  <style is:global>
    @keyframes pulse-slow { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.35; transform: scale(1.1); } }
    @keyframes pulse-slow2 { 0%, 100% { opacity: 0.15; transform: scale(1); } 50% { opacity: 0.25; transform: scale(1.15); } }
    @keyframes pulse-slow3 { 0%, 100% { opacity: 0.1; transform: scale(1); } 50% { opacity: 0.2; transform: scale(1.05); } }
    .animate-pulse-slow { animation: pulse-slow 8s ease-in-out infinite; }
    .animate-pulse-slow2 { animation: pulse-slow2 12s ease-in-out infinite 2s; }
    .animate-pulse-slow3 { animation: pulse-slow3 10s ease-in-out infinite 4s; }
  </style>
</Layout>
